#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
„Éá„Éº„Çø„Éô„Éº„Çπ„Éû„Éç„Éº„Ç∏„É£„Éº v4
Âú∞ÂêçÊäΩÂá∫„ÉªÊ≠£Ë¶èÂåñ„Ç∑„Çπ„ÉÜ„É†„Å®ÈÄ£Êê∫„Åó„Åü„Éá„Éº„Çø„Éô„Éº„ÇπÁÆ°ÁêÜ
"""

import sqlite3
import logging
from typing import List, Dict, Optional, Tuple
from datetime import datetime

from ..extractors_v4.unified_place_extractor import UnifiedPlaceExtractor, UnifiedPlace
from ..extractors_v4.place_normalizer import PlaceNormalizer, NormalizedPlace
from .models import Work

logger = logging.getLogger(__name__)

class DatabaseManager:
    """„Éá„Éº„Çø„Éô„Éº„Çπ„Éû„Éç„Éº„Ç∏„É£„Éº v4"""
    
    def __init__(self, db_path: str = '/app/bungo-map-v4/data/databases/bungo_v4.db'):
        """ÂàùÊúüÂåñ"""
        self.db_path = db_path
        logger.info(f"üåü „Éá„Éº„Çø„Éô„Éº„Çπ„Éû„Éç„Éº„Ç∏„É£„Éºv4ÂàùÊúüÂåñ: DB„Éë„Çπ = {self.db_path}")
        self.unified_extractor = UnifiedPlaceExtractor()
        self.normalizer = PlaceNormalizer()
        logger.info("üåü „Éá„Éº„Çø„Éô„Éº„Çπ„Éû„Éç„Éº„Ç∏„É£„Éºv4ÂàùÊúüÂåñÂÆå‰∫Ü")
    
    def process_work(self, work_id: int, text: str, context_before: str = "", context_after: str = "") -> Dict:
        """‰ΩúÂìÅ„ÅÆÂá¶ÁêÜ"""
        try:
            # Âú∞ÂêçÊäΩÂá∫
            places = self.unified_extractor.extract_places(
                work_id, text, context_before, context_after
            )
            
            # „Éá„Éº„Çø„Éô„Éº„Çπ„Å´‰øùÂ≠ò
            saved_places = self._save_places(places)
            
            # Áµ±Ë®àÊÉÖÂ†±„ÅÆÊõ¥Êñ∞
            self._update_statistics(work_id)
            
            return {
                'work_id': work_id,
                'total_places': len(places),
                'saved_places': saved_places,
                'success': True
            }
        
        except Exception as e:
            logger.error(f"‰ΩúÂìÅÂá¶ÁêÜ„Ç®„É©„Éº: {e}")
            return {
                'work_id': work_id,
                'error': str(e),
                'success': False
            }
    
    def _save_places(self, places: List[UnifiedPlace]) -> List[Dict]:
        """Âú∞Âêç„ÅÆ‰øùÂ≠ò"""
        saved_places = []
        
        try:
            with sqlite3.connect(self.db_path) as conn:
                for place in places:
                    # places_master„Å´ËøΩÂä†ÔºàÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØÔºâ
                    cursor = conn.execute("""
                        SELECT place_id FROM places_master 
                        WHERE canonical_name = ?
                    """, (place.canonical_name,))
                    
                    result = cursor.fetchone()
                    if result:
                        place_id = result[0]
                    else:
                        # Êñ∞Ë¶èÂú∞ÂêçËøΩÂä†
                        cursor = conn.execute("""
                            INSERT INTO places_master (
                                place_name, canonical_name, place_type,
                                prefecture, confidence, verification_status,
                                created_at, updated_at
                            )
                            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
                        """, (
                            place.place_name,
                            place.canonical_name,
                            place.place_type,
                            place.prefecture,
                            place.confidence,
                            'pending',
                            place.created_at,
                            place.updated_at
                        ))
                        place_id = cursor.lastrowid
                    
                    # sentence_places„Å´ËøΩÂä†
                    cursor = conn.execute("""
                        INSERT INTO sentence_places (
                            sentence_id, place_id, extraction_method,
                            confidence, context_before, context_after,
                            matched_text, verification_status,
                            quality_score, relevance_score,
                            created_at, updated_at
                        )
                        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                """, (
                        place.work_id,  # sentence_id„Å®„Åó„Å¶work_id„Çí‰ΩøÁî®
                        place_id,
                        place.extraction_method,
                        place.confidence,
                        place.context_before,
                        place.context_after,
                        place.place_name,
                        'auto',
                        0.0,  # ÂàùÊúüÂìÅË≥™„Çπ„Ç≥„Ç¢
                        0.0,  # ÂàùÊúüÈñ¢ÈÄ£ÊÄß„Çπ„Ç≥„Ç¢
                        place.created_at,
                        place.updated_at
                    ))
                    
                    saved_places.append({
                        'place_id': place_id,
                        'place_name': place.place_name,
                        'canonical_name': place.canonical_name,
                        'place_type': place.place_type,
                        'prefecture': place.prefecture,
                        'confidence': place.confidence
                    })
                
                conn.commit()
        
        except Exception as e:
            logger.error(f"Âú∞Âêç‰øùÂ≠ò„Ç®„É©„Éº: {e}")
            raise
        
        return saved_places
    
    def _update_statistics(self, work_id: int):
        """Áµ±Ë®àÊÉÖÂ†±„ÅÆÊõ¥Êñ∞"""
        try:
            with sqlite3.connect(self.db_path) as conn:
                # ‰ΩúÂìÅ„ÅÆÂú∞ÂêçÁµ±Ë®à„ÇíÊõ¥Êñ∞
                conn.execute("""
                    UPDATE works 
                    SET place_count = (
                        SELECT COUNT(DISTINCT pm.place_id)
                FROM places_master pm
                JOIN sentence_places sp ON pm.place_id = sp.place_id
                WHERE sp.sentence_id = ?
                    ),
                    updated_at = ?
                    WHERE work_id = ?
                """, (work_id, datetime.now().isoformat(), work_id))
                
                # ‰ΩúËÄÖ„ÅÆÂú∞ÂêçÁµ±Ë®à„ÇíÊõ¥Êñ∞
                conn.execute("""
                    UPDATE authors 
                    SET place_count = (
                        SELECT COUNT(DISTINCT pm.place_id)
                        FROM places_master pm
                        JOIN sentence_places sp ON pm.place_id = sp.place_id
                        JOIN works w ON sp.sentence_id = w.work_id
                        WHERE w.author_id = authors.author_id
                    ),
                    updated_at = ?
                    WHERE author_id = (
                        SELECT author_id FROM works WHERE work_id = ?
                    )
                """, (datetime.now().isoformat(), work_id))
                
                conn.commit()
        
        except Exception as e:
            logger.error(f"Áµ±Ë®àÊõ¥Êñ∞„Ç®„É©„Éº: {e}")
            raise
    
    def get_work_statistics(self, work_id: int) -> Dict:
        """‰ΩúÂìÅ„ÅÆÁµ±Ë®àÊÉÖÂ†±ÂèñÂæó"""
        try:
            with sqlite3.connect(self.db_path) as conn:
                cursor = conn.execute("""
                    SELECT 
                        w.work_title,
                        w.place_count,
                        w.sentence_count,
                        a.author_name,
                        COUNT(DISTINCT pm.place_id) as unique_places,
                        COUNT(sp.id) as total_mentions
                    FROM works w
                    JOIN authors a ON w.author_id = a.author_id
                    LEFT JOIN sentence_places sp ON sp.sentence_id = w.work_id
                    LEFT JOIN places_master pm ON sp.place_id = pm.place_id
                    WHERE w.work_id = ?
                    GROUP BY w.work_id
                """, (work_id,))
                result = cursor.fetchone()
                if result:
                    return {
                        'work_title': result[0],
                        'place_count': result[1],
                        'sentence_count': result[2],
                        'author_name': result[3],
                        'unique_places': result[4],
                        'total_mentions': result[5]
                    }
                return {}
        except Exception as e:
            logger.error(f"Áµ±Ë®àÂèñÂæó„Ç®„É©„Éº: {e}")
            return {}
    
    def get_author_statistics(self, author_id: int) -> Dict[str, int]:
        """‰ΩúËÄÖ„ÅÆÁµ±Ë®àÊÉÖÂ†±„ÇíÂèñÂæó"""
        try:
            with sqlite3.connect(self.db_path) as conn:
                cursor = conn.execute("""
                    SELECT 
                        COUNT(DISTINCT s.sentence_id) as total_sentences,
                        COUNT(DISTINCT pm.place_id) as total_places,
                        COUNT(DISTINCT CASE WHEN pm.latitude IS NOT NULL THEN pm.place_id END) as geocoded_places
                    FROM authors a
                    LEFT JOIN works w ON a.author_id = w.author_id
                    LEFT JOIN sentences s ON w.work_id = s.work_id
                    LEFT JOIN sentence_places sp ON s.sentence_id = sp.sentence_id
                    LEFT JOIN places_master pm ON sp.place_id = pm.place_id
                    WHERE a.author_id = ?
                """, (author_id,))
                result = cursor.fetchone()
                if result:
                    return {
                        'total_sentences': result[0] or 0,
                        'total_places': result[1] or 0,
                        'geocoded_places': result[2] or 0
                    }
                return {
                    'total_sentences': 0,
                    'total_places': 0,
                    'geocoded_places': 0
                }
        except Exception as e:
            logger.error(f"‰ΩúËÄÖÁµ±Ë®àÂèñÂæó„Ç®„É©„Éº: {e}")
            return {
                'total_sentences': 0,
                'total_places': 0,
                'geocoded_places': 0
            }
    
    def save_author(self, author) -> Optional[int]:
        """‰ΩúËÄÖÊÉÖÂ†±„Çí‰øùÂ≠ò„Åó„ÄÅID„ÇíËøî„Åô„ÄÇÊó¢Â≠ò„Å™„Çâ„Åù„ÅÆID„ÇíËøî„Åô"""
        try:
            with sqlite3.connect(self.db_path) as conn:
                cursor = conn.execute(
                    "SELECT author_id FROM authors WHERE author_name = ?",
                    (author.author_name,)
                )
                result = cursor.fetchone()
                if result:
                    return result[0]
                # Êñ∞Ë¶è‰ΩúÊàê
                cursor = conn.execute(
                    """
                    INSERT INTO authors (author_name, source_system, created_at, updated_at)
                    VALUES (?, ?, ?, ?)
                    """,
                    (
                        author.author_name,
                        getattr(author, 'source_system', 'aozora'),
                        datetime.now().isoformat(),
                        datetime.now().isoformat()
                    )
                )
                return cursor.lastrowid
        except Exception as e:
            logger.error(f"‰ΩúËÄÖ‰øùÂ≠ò„Ç®„É©„Éº: {e}")
            return None

    def save_work(self, work: Work) -> Optional[int]:
        """‰ΩúÂìÅÊÉÖÂ†±„Çí‰øùÂ≠ò"""
        try:
            with sqlite3.connect(self.db_path) as conn:
                cursor = conn.execute("""
                    INSERT INTO works (
                        work_title,
                        author_id,
                        aozora_url,
                        source_system,
                        created_at,
                        updated_at
                    ) VALUES (?, ?, ?, ?, ?, ?)
                """, (
                    work.work_title,
                    work.author_id,
                    work.aozora_url,
                    work.source_system,
                    datetime.now(),
                    datetime.now()
                ))
                conn.commit()
                return cursor.lastrowid
        except Exception as e:
            logger.error(f"‰ΩúÂìÅ‰øùÂ≠ò„Ç®„É©„Éº: {e}")
            return None

    def save_sentence(self, sentence) -> bool:
        """„Çª„É≥„ÉÜ„É≥„Çπ„Çí‰øùÂ≠ò"""
        try:
            with sqlite3.connect(self.db_path) as conn:
                cursor = conn.execute("""
                    INSERT INTO sentences (
                        sentence_text, work_id, author_id, position_in_work,
                        sentence_length, created_at, updated_at
                    )
                    VALUES (?, ?, ?, ?, ?, ?, ?)
                """, (
                    sentence.sentence_text,
                    sentence.work_id,
                    sentence.author_id,
                    sentence.position_in_work,
                    sentence.sentence_length,
                    datetime.now().isoformat(),
                    datetime.now().isoformat()
                ))
                conn.commit()
                return True
        except Exception as e:
            logger.error(f"„Çª„É≥„ÉÜ„É≥„Çπ‰øùÂ≠ò„Ç®„É©„Éº: {e}")
            return False

if __name__ == "__main__":
    # Á∞°Âçò„Å™„ÉÜ„Çπ„Éà
    manager = DatabaseManager()
    
    test_work = {
        'work_id': 1,
        'text': 'Êù±‰∫¨„ÅÆÈäÄÂ∫ß„ÅßË≤∑„ÅÑÁâ©„Çí„Åó„ÅüÂæå„ÄÅÊñ∞ÂÆø„Å∏ÁßªÂãï„Åó„Åü„ÄÇ',
        'context_before': '‰∏ª‰∫∫ÂÖ¨„ÅØ',
        'context_after': '„Å®„ÅÑ„ÅÜ‰∏ÄÊó•„ÇíÈÅé„Åî„Åó„Åü„ÄÇ'
    }
    
    result = manager.process_work(**test_work)
    
    print("‚úÖ „Éá„Éº„Çø„Éô„Éº„Çπ„Éû„Éç„Éº„Ç∏„É£„Éºv4„ÉÜ„Çπ„ÉàÂÆå‰∫Ü")
    print(f"üìä Âá¶ÁêÜÁµêÊûú:")
    print(f"  ‰ΩúÂìÅID: {result['work_id']}")
    print(f"  ÊäΩÂá∫Âú∞ÂêçÊï∞: {result['total_places']}")
    print(f"  ‰øùÂ≠òÂú∞ÂêçÊï∞: {len(result['saved_places'])}")
    
    if result['saved_places']:
        print("\nüó∫Ô∏è ‰øùÂ≠ò„Åï„Çå„ÅüÂú∞Âêç:")
        for place in result['saved_places']:
            print(f"  ‚Ä¢ {place['place_name']} ‚Üí {place['canonical_name']}")
            print(f"    „Çø„Ç§„Éó: {place['place_type']}")
            if place['prefecture']:
                print(f"    ÈÉΩÈÅìÂ∫úÁúå: {place['prefecture']}")
            print(f"    ‰ø°È†ºÂ∫¶: {place['confidence']:.2f}") 