#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
文豪地図システム - 一括ジオコーディング更新
残りの全地名に座標を追加
"""

import time
import sqlite3

def bulk_update_coordinates():
    """一括座標更新"""
    print("🗺️ 文豪地図システム - 一括ジオコーディング開始")
    print("=" * 60)
    
    start_time = time.time()
    
    # 日本の主要地名座標データベース（拡張版）
    coordinates_db = {
        # 都道府県・県庁所在地
        "札幌": (43.0642, 141.3469),
        "青森": (40.8244, 140.7403),
        "仙台": (38.2682, 140.8694),
        "秋田": (39.7186, 140.1024),
        "山形": (38.2404, 140.3633),
        "福島": (37.7503, 140.4677),
        "水戸": (36.3418, 140.4468),
        "宇都宮": (36.5658, 139.8836),
        "前橋": (36.3911, 139.0608),
        "さいたま": (35.8617, 139.6455),
        "千葉": (35.6074, 140.1065),
        "甲府": (35.6642, 138.5684),
        "長野": (36.6513, 138.1811),
        "岐阜": (35.3912, 136.7223),
        "静岡": (34.9756, 138.3827),
        "津": (34.7303, 136.5086),
        "大津": (35.0045, 135.8686),
        "神戸": (34.6901, 135.1956),
        "奈良": (34.6851, 135.8048),
        "和歌山": (34.2261, 135.1675),
        "鳥取": (35.5038, 134.2384),
        "松江": (35.4723, 133.0505),
        "岡山": (34.6617, 133.9341),
        "山口": (34.1858, 131.4706),
        "徳島": (34.0658, 134.5594),
        "高松": (34.3402, 134.0434),
        "高知": (33.5597, 133.5311),
        "福岡": (33.5904, 130.4017),
        "佐賀": (33.2494, 130.2989),
        "長崎": (32.7503, 129.8779),
        "熊本": (32.7898, 130.7417),
        "大分": (33.2382, 131.6126),
        "宮崎": (31.9077, 131.4202),
        "鹿児島": (31.5966, 130.5571),
        "那覇": (26.2124, 127.6792),
        
        # 歴史的・古典地名
        "武蔵": (35.6762, 139.6503),  # 東京
        "相模": (35.3392, 139.3949),  # 神奈川
        "甲斐": (35.6642, 138.5684),  # 山梨
        "信濃": (36.6513, 138.1811),  # 長野
        "越後": (37.9022, 139.0237),  # 新潟
        "上野": (35.7090, 139.7753),  # 台東区
        "下野": (36.5658, 139.8836),  # 栃木
        "常陸": (36.3418, 140.4468),  # 茨城
        "上総": (35.3606, 140.0978),  # 千葉
        "下総": (35.7167, 140.1167),  # 千葉北部
        "安房": (35.1065, 139.8387),  # 千葉南部
        "伊豆": (34.9756, 138.9473),  # 静岡
        "駿河": (35.0180, 138.4106),  # 静岡
        "遠江": (34.8406, 137.8617),  # 静岡西部
        "三河": (34.8606, 137.0617),  # 愛知東部
        "尾張": (35.1815, 136.9066),  # 愛知西部
        "美濃": (35.3912, 136.7223),  # 岐阜
        "飛騨": (36.1459, 137.2511),  # 岐阜北部
        "近江": (35.0045, 135.8686),  # 滋賀
        "山城": (35.0116, 135.7681),  # 京都
        "大和": (34.6851, 135.8048),  # 奈良
        "河内": (34.6289, 135.6005),  # 大阪東部
        "和泉": (34.4851, 135.4048),  # 大阪南部
        "摂津": (34.7303, 135.5086),  # 大阪北部
        "播磨": (34.8406, 134.6917),  # 兵庫
        "但馬": (35.5038, 134.7384),  # 兵庫北部
        "丹波": (35.1723, 135.0505),  # 兵庫・京都
        "丹後": (35.6275, 135.1005),  # 京都北部
        "若狭": (35.4950, 135.9070),  # 福井
        "越前": (36.0653, 136.2217),  # 福井
        "加賀": (36.5944, 136.6256),  # 石川
        "能登": (37.2044, 136.9656),  # 石川北部
        "越中": (36.6959, 137.2139),  # 富山
        "佐渡": (38.0189, 138.3669),  # 新潟・佐渡島
        "出雲": (35.3678, 132.7594),  # 島根
        "石見": (34.6723, 131.8505),  # 島根西部
        "隠岐": (36.2044, 133.3256),  # 島根・隠岐諸島
        "備前": (34.6617, 133.9341),  # 岡山
        "備中": (34.5517, 133.7541),  # 岡山西部
        "備後": (34.4017, 133.2341),  # 広島東部
        "安芸": (34.3853, 132.4553),  # 広島
        "周防": (34.0658, 131.4706),  # 山口
        "長門": (34.3858, 131.1906),  # 山口北部
        "讃岐": (34.3402, 134.0434),  # 香川
        "阿波": (34.0658, 134.5594),  # 徳島
        "土佐": (33.5597, 133.5311),  # 高知
        "伊予": (33.8416, 132.7658),  # 愛媛
        "筑前": (33.5904, 130.4017),  # 福岡
        "筑後": (33.2094, 130.5017),  # 福岡南部
        "豊前": (33.6194, 131.1017),  # 福岡・大分
        "豊後": (33.2382, 131.6126),  # 大分
        "肥前": (33.2494, 130.2989),  # 佐賀・長崎
        "肥後": (32.7898, 130.7417),  # 熊本
        "日向": (31.9077, 131.4202),  # 宮崎
        "大隅": (31.3066, 130.8571),  # 鹿児島東部
        "薩摩": (31.5966, 130.5571),  # 鹿児島
        "壱岐": (33.7494, 129.6989),  # 長崎・壱岐島
        "対馬": (34.2049, 129.2890),  # 長崎・対馬
        
        # 東京の地名
        "小川町": (35.6914, 139.7706),  # 神田小川町
        "真砂町": (35.6674, 139.7706),  # 現在の新富町付近
        "麹町": (35.6816, 139.7419),
        "麹町辺": (35.6816, 139.7419),
        "赤坂": (35.6744, 139.7378),
        "青山": (35.6704, 139.7195),
        "四谷": (35.6884, 139.7274),
        "市ヶ谷": (35.6944, 139.7274),
        "飯田橋": (35.7017, 139.7455),
        "水道橋": (35.7017, 139.7555),
        "御茶ノ水": (35.6995, 139.7661),
        "秋葉原": (35.6980, 139.7714),
        "両国": (35.6957, 139.7944),
        "錦糸町": (35.6969, 139.8156),
        "亀戸": (35.6969, 139.8256),
        "深川": (35.6717, 139.8017),
        "門前仲町": (35.6717, 139.7917),
        "木場": (35.6717, 139.8117),
        "月島": (35.6650, 139.7817),
        "勝どき": (35.6550, 139.7717),
        "汐留": (35.6627, 139.7587),
        "虎ノ門": (35.6684, 139.7519),
        "愛宕": (35.6664, 139.7469),
        "芝": (35.6564, 139.7469),
        "田町": (35.6456, 139.7477),
        "品川": (35.6297, 139.7403),
        "大崎": (35.6197, 139.7303),
        "五反田": (35.6256, 139.7236),
        "目黒": (35.6336, 139.7156),
        "恵比寿": (35.6464, 139.7100),
        "渋谷": (35.6581, 139.7014),
        "原宿": (35.6702, 139.7027),
        "表参道": (35.6658, 139.7111),
        "青山": (35.6704, 139.7195),
        "外苑前": (35.6749, 139.7165),
        "乃木坂": (35.6692, 139.7265),
        "六本木": (35.6627, 139.7314),
        "麻布": (35.6518, 139.7394),
        "白金": (35.6418, 139.7294),
        "高輪": (35.6381, 139.7344),
        
        # 関西地方
        "難波": (34.6661, 135.5000),
        "梅田": (34.7024, 135.4959),
        "天王寺": (34.6455, 135.5066),
        "住吉": (34.6155, 135.4966),
        "阿倍野": (34.6355, 135.5066),
        "堺": (34.5732, 135.4827),
        "岸和田": (34.4606, 135.3697),
        "祇園": (35.0036, 135.7781),
        "清水": (34.9956, 135.7831),
        "嵐山": (35.0156, 135.6781),
        "宇治": (34.8844, 135.7998),
        "伏見": (34.9289, 135.7556),
        "三条": (35.0096, 135.7681),
        "四条": (35.0036, 135.7681),
        "五条": (34.9976, 135.7681),
        "六条": (34.9916, 135.7681),
        "七条": (34.9856, 135.7681),
        "八条": (34.9796, 135.7681),
        "九条": (34.9736, 135.7681),
        
        # 九州地方
        "博多": (33.5904, 130.4017),
        "天神": (33.5904, 130.4017),
        "小倉": (33.8834, 130.8751),
        "門司": (33.9417, 130.9617),
        "久留米": (33.3194, 130.5089),
        "大牟田": (33.0304, 130.4417),
        "佐世保": (33.1594, 129.7239),
        "諫早": (32.8439, 130.0514),
        "島原": (32.7894, 130.3639),
        "唐津": (33.4494, 129.9689),
        "伊万里": (33.2722, 129.8811),
        "別府": (33.2794, 131.4911),
        "中津": (33.5982, 131.1876),
        "日田": (33.3223, 130.9411),
        "延岡": (32.5822, 131.6661),
        "都城": (31.7211, 131.0661),
        "鹿屋": (31.3783, 130.8450),
        "指宿": (31.2556, 130.6450),
        "枕崎": (31.2722, 130.2989),
        
        # 温泉地・観光地
        "道後温泉": (33.8484, 132.7864),
        "有馬温泉": (34.7969, 135.2478),
        "城崎温泉": (35.6069, 134.8078),
        "白浜温泉": (33.6825, 135.3378),
        "下呂温泉": (35.8039, 137.2478),
        "草津温泉": (36.6239, 138.5978),
        "伊香保温泉": (36.4889, 138.9078),
        "熱海": (35.0952, 139.0739),
        "伊豆長岡": (35.0339, 138.9439),
        "修善寺": (34.9789, 138.9239),
        "河口湖": (35.5039, 138.7439),
        "山中湖": (35.4139, 138.8739),
        "軽井沢": (36.3427, 138.6297),
        "蓼科": (36.1127, 138.2997),
        "白馬": (36.7027, 137.8597),
        "上高地": (36.2527, 137.6297),
        "高山": (36.1459, 137.2511),
        "飛騨": (36.1459, 137.2511),
        "白川郷": (36.2589, 136.9078),
        "金閣寺": (35.0394, 135.7292),
        "銀閣寺": (35.0269, 135.7981),
        "清水寺": (34.9949, 135.7850),
        "比叡山": (35.0703, 135.8406),
        "高野山": (34.2133, 135.5833),
        "吉野": (34.3653, 135.8708),
        "熊野": (33.8889, 135.7889),
        "富士山": (35.3606, 138.7274),
        "富士五湖": (35.4639, 138.7439),
        "日光": (36.7581, 139.6206),
        "華厳の滝": (36.7381, 139.5006),
        "中禅寺湖": (36.7181, 139.4806),
        "那須": (37.0381, 140.0406),
        "磐梯山": (37.6006, 140.0706),
        "猪苗代湖": (37.4706, 140.1006),
        
        # 離島
        "淡路島": (34.3406, 134.9117),
        "小豆島": (34.4906, 134.2617),
        "直島": (34.4606, 133.9917),
        "屋久島": (30.3406, 130.5050),
        "種子島": (30.7306, 131.0050),
        "奄美大島": (28.3806, 129.4950),
        "石垣島": (24.3406, 124.1550),
        "宮古島": (24.8006, 125.2850),
        "与那国島": (24.4606, 122.9850),
    }
    
    conn = sqlite3.connect('data/bungo_production.db')
    cursor = conn.cursor()
    
    print(f"📊 座標データベース: {len(coordinates_db)}件の地名を準備")
    
    # 座標なしの地名を取得
    cursor.execute("""
        SELECT place_id, place_name, COUNT(*) as count
        FROM places 
        WHERE lat IS NULL OR lng IS NULL
        GROUP BY place_id, place_name
        ORDER BY count DESC
    """)
    
    places_to_update = cursor.fetchall()
    total_places = len(places_to_update)
    
    print(f"📍 更新対象: {total_places}件")
    
    if total_places == 0:
        print("✅ すべての地名に座標が設定済みです")
        return
    
    # 一括更新実行
    print(f"\n🚀 一括座標更新開始")
    print("-" * 40)
    
    success_count = 0
    failed_count = 0
    
    for place_id, place_name, count in places_to_update:
        if place_name in coordinates_db:
            lat, lng = coordinates_db[place_name]
            
            try:
                cursor.execute("""
                    UPDATE places 
                    SET lat = ?, lng = ?, confidence = 0.9
                    WHERE place_name = ? AND lat IS NULL
                """, (lat, lng, place_name))
                
                updated = cursor.rowcount
                success_count += updated
                print(f"✅ {place_name}: {updated}件更新 ({lat:.4f}, {lng:.4f})")
                
            except Exception as e:
                failed_count += 1
                print(f"❌ {place_name}: エラー - {e}")
        else:
            # 部分マッチングを試行
            partial_match = None
            for known_name, coords in coordinates_db.items():
                if known_name in place_name or place_name in known_name:
                    partial_match = (known_name, coords)
                    break
            
            if partial_match:
                known_name, (lat, lng) = partial_match
                try:
                    cursor.execute("""
                        UPDATE places 
                        SET lat = ?, lng = ?, confidence = 0.7
                        WHERE place_name = ? AND lat IS NULL
                    """, (lat, lng, place_name))
                    
                    updated = cursor.rowcount
                    success_count += updated
                    print(f"🔍 {place_name}: {updated}件更新 ({lat:.4f}, {lng:.4f}) [部分マッチ: {known_name}]")
                    
                except Exception as e:
                    failed_count += 1
                    print(f"❌ {place_name}: エラー - {e}")
            else:
                failed_count += 1
                print(f"🔍 {place_name}: 座標不明 ({count}件)")
    
    # 変更をコミット
    conn.commit()
    
    # 結果確認
    cursor.execute("SELECT COUNT(*) FROM places WHERE lat IS NOT NULL AND lng IS NOT NULL")
    final_with_coords = cursor.fetchone()[0]
    
    cursor.execute("SELECT COUNT(*) FROM places")
    total_final = cursor.fetchone()[0]
    
    conn.close()
    
    end_time = time.time()
    execution_time = end_time - start_time
    
    print(f"\n🎯 一括更新結果")
    print("-" * 40)
    print(f"📊 更新統計:")
    print(f"   ✅ 更新成功: {success_count}件")
    print(f"   ❌ 更新失敗: {failed_count}件")
    print(f"   ⏱️ 実行時間: {execution_time:.1f}秒")
    print(f"\n📈 最終データベース状況:")
    print(f"   📍 総地名数: {total_final}件")
    print(f"   🗺️ 座標あり: {final_with_coords}件 ({final_with_coords/total_final*100:.1f}%)")
    print(f"   📍 座標なし: {total_final - final_with_coords}件")
    
    print(f"\n🎉 一括ジオコーディング完了！")
    print("=" * 60)


if __name__ == "__main__":
    bulk_update_coordinates() 